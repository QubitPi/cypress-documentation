"use strict";(self.webpackChunkcypress_docusaurus_ts=self.webpackChunkcypress_docusaurus_ts||[]).push([[2237],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var i=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=i.createContext({}),p=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=p(e.components);return i.createElement(l.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},m=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=p(n),m=a,h=u["".concat(l,".").concat(m)]||u[m]||c[m]||o;return n?i.createElement(h,r(r({ref:t},d),{},{components:n})):i.createElement(h,r({ref:t},d))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,r=new Array(o);r[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:a,r[1]=s;for(var p=2;p<o;p++)r[p]=n[p];return i.createElement.apply(null,r)}return i.createElement.apply(null,n)}m.displayName="MDXCreateElement"},3057:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var i=n(7462),a=(n(7294),n(3905));const o={title:"AWS CodeBuild"},r=void 0,s={unversionedId:"guides/continuous-integration/aws-codebuild",id:"guides/continuous-integration/aws-codebuild",title:"AWS CodeBuild",description:"What you'll learn",source:"@site/docs/guides/continuous-integration/aws-codebuild.mdx",sourceDirName:"guides/continuous-integration",slug:"/guides/continuous-integration/aws-codebuild",permalink:"/cypress-documentation/guides/continuous-integration/aws-codebuild",draft:!1,editUrl:"https://github.com/cypress-io/cypress-documentation/tree/main/docs/guides/continuous-integration/aws-codebuild.mdx",tags:[],version:"current",lastUpdatedAt:1696480060,formattedLastUpdatedAt:"Oct 5, 2023",frontMatter:{title:"AWS CodeBuild"},sidebar:"guides",previous:{title:"CI Provider Examples",permalink:"/cypress-documentation/guides/continuous-integration/ci-provider-examples"},next:{title:"Bitbucket Pipelines",permalink:"/cypress-documentation/guides/continuous-integration/bitbucket-pipelines"}},l={},p=[{value:"Basic Setup",id:"Basic-Setup",level:2},{value:"Testing in Chrome and Firefox with Cypress Docker Images",id:"Testing-in-Chrome-and-Firefox-with-Cypress-Docker-Images",level:2},{value:"Caching Dependencies and Build Artifacts",id:"Caching-Dependencies-and-Build-Artifacts",level:2},{value:"Parallelization",id:"Parallelization",level:2},{value:"Parallelizing the build",id:"Parallelizing-the-build",level:3},{value:"Using Cypress Cloud with AWS CodeBuild",id:"Using-Cypress-Cloud-with-AWS-CodeBuild",level:2},{value:"Cypress Real World Example with AWS CodeBuild",id:"Cypress-Real-World-Example-with-AWS-CodeBuild",level:2}],d=e=>function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,a.kt)("div",t)},u=d("Icon"),c=d("CiProviderCloudSteps"),m={toc:p};function h(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,i.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("h2",{parentName:"admonition",id:"What-youll-learn"},(0,a.kt)(u,{name:"graduation-cap",mdxType:"Icon"})," What you'll learn"),(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},"How to run Cypress tests with AWS CodeBuild as part of CI/CD pipeline"),(0,a.kt)("li",{parentName:"ul"},"How to parallelize Cypress test runs within AWS CodeBuild"))),(0,a.kt)("p",null,"With ",(0,a.kt)("a",{parentName:"p",href:"https://aws.amazon.com/codebuild/"},"AWS CodeBuild"),' Amazon Web Services\n(AWS) offers developers "...a fully managed build service that compiles your\nsource code, runs unit tests, and produces artifacts that are ready to deploy"\nallowing teams to "pay only for the build time you use".'),(0,a.kt)("p",null,"Detailed documentation is available in the\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/"},"AWS CodeBuild Documentation"),"."),(0,a.kt)("h2",{id:"Basic-Setup"},"Basic Setup"),(0,a.kt)("p",null,"The example below is basic CI setup and job using the\n",(0,a.kt)("a",{parentName:"p",href:"https://aws.amazon.com/codebuild/"},"AWS CodeBuild")," to run Cypress tests within\nthe Electron browser. This AWS CodeBuild configuration is placed within\n",(0,a.kt)("inlineCode",{parentName:"p"},"buildspec.yml"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'## buildspec.yml\nversion: 0.2\n\nphases:\n  install:\n    runtime-versions:\n      nodejs: latest\n    commands:\n      # Set COMMIT_INFO variables to send Git specifics to Cypress Cloud when recording\n      # https://docs.cypress.io/guides/continuous-integration/introduction#Git-information\n      - export COMMIT_INFO_BRANCH="$(git rev-parse HEAD | xargs git name-rev |\n        cut -d\' \' -f2 | sed \'s/remotes\\/origin\\///g\')"\n      - export COMMIT_INFO_MESSAGE="$(git log -1 --pretty=%B)"\n      - export COMMIT_INFO_EMAIL="$(git log -1 --pretty=%ae)"\n      - export COMMIT_INFO_AUTHOR="$(git log -1 --pretty=%an)"\n      - export COMMIT_INFO_SHA="$(git log -1 --pretty=%H)"\n      - export COMMIT_INFO_REMOTE="$(git config --get remote.origin.url)"\n      - npm ci\n  pre_build:\n    commands:\n      - npm run cy:verify\n      - npm run cy:info\n  build:\n    commands:\n      - npm run start:ci &\n      - npx cypress run --record\n')),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("strong",null,"Try it out"),(0,a.kt)("p",{parentName:"admonition"},"To try out the example above yourself, fork the\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/cypress-io/cypress-example-kitchensink"},"Cypress Kitchen Sink"),"\nexample project and place the above\n",(0,a.kt)("a",{parentName:"p",href:"https://aws.amazon.com/codebuild/"},"AWS CodeBuild")," configuration in\n",(0,a.kt)("inlineCode",{parentName:"p"},"buildspec.yml"),".")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"How this buildspec works:")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"On ",(0,a.kt)("em",{parentName:"li"},"push")," to this repository, this job will provision and start AWS-hosted\nAmazon Linux instance with Node.js for running the outlined ",(0,a.kt)("inlineCode",{parentName:"li"},"pre_build")," and\n",(0,a.kt)("inlineCode",{parentName:"li"},"build")," for the declared commands within the ",(0,a.kt)("inlineCode",{parentName:"li"},"commands")," section of the\nconfiguration."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://aws.amazon.com/codebuild/"},"AWS CodeBuild")," will checkout our code from\nour GitHub repository."),(0,a.kt)("li",{parentName:"ul"},"Finally, our ",(0,a.kt)("inlineCode",{parentName:"li"},"buildspec.yml")," configuration will:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Install npm dependencies"),(0,a.kt)("li",{parentName:"ul"},"Start the project web server (",(0,a.kt)("inlineCode",{parentName:"li"},"npm start:ci"),")"),(0,a.kt)("li",{parentName:"ul"},"Run the Cypress tests within our GitHub repository within Electron.")))),(0,a.kt)("h2",{id:"Testing-in-Chrome-and-Firefox-with-Cypress-Docker-Images"},"Testing in Chrome and Firefox with Cypress Docker Images"),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"As of version 0.2, CodeBuild does not provide a way to specify a custom image\nfor single build configurations. One way to solve this is using an\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html#build-spec.batch.build-list"},"AWS CodeBuild batch build-list strategy"),".")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("strong",null,"Enabling batch builds in the CodeBuild UI for the project"),(0,a.kt)("br",null),(0,a.kt)("br",null),(0,a.kt)("p",{parentName:"admonition"},"Per the\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html"},"AWS CodeBuild batch build documentation"),",\nAWS CodeBuild creates a separate build for each possible configuration\ncombination for a\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html#build-spec.batch.build-list"},"batch build-list strategy"),".\nTherefore, AWS CodeBuild projects must be created or updated to run batch\nconfiguration."),(0,a.kt)("p",{parentName:"admonition"},"Follow these steps to enable batch configuration for existing AWS CodeBuild\nprojects:"),(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},"Navigate to the AWS CodeBuild Console"),(0,a.kt)("li",{parentName:"ul"},"Select the project"),(0,a.kt)("li",{parentName:"ul"},'Click "Edit" --\x3e "Batch Configuration"'),(0,a.kt)("li",{parentName:"ul"},'Create "New service Role" and enter the name of the role'),(0,a.kt)("li",{parentName:"ul"},"Leave all other options as optional"),(0,a.kt)("li",{parentName:"ul"},'Click "Update batch configuration"'),(0,a.kt)("li",{parentName:"ul"},"Start the Build"))),(0,a.kt)("p",null,"AWS CodeBuild offers a\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html#build-spec.batch.build-list"},"build-list strategy"),"\nof different job configurations for a single job definition."),(0,a.kt)("p",null,"The\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html#build-spec.batch.build-list"},"build-list strategy"),"\noffers a way to specify an image hosted on DockerHub or the\n",(0,a.kt)("a",{parentName:"p",href:"https://aws.amazon.com/ecr/"},"Amazon Elastic Container Registry (ECR)"),"."),(0,a.kt)("p",null,"The Cypress team maintains the official\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/cypress-io/cypress-docker-images"},"Docker Images")," for running\nCypress locally and in CI, which are built with Google Chrome and Firefox. For\nexample, this allows us to run the tests in Firefox by passing the\n",(0,a.kt)("inlineCode",{parentName:"p"},"--browser firefox")," attribute to ",(0,a.kt)("inlineCode",{parentName:"p"},"cypress run"),"."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("strong",null,"Cypress Amazon Public ECR"),(0,a.kt)("p",{parentName:"admonition"},"The Cypress team has published it's\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/cypress-io/cypress-docker-images"},"Docker Images")," for running\nCypress locally and in CI in the\n",(0,a.kt)("a",{parentName:"p",href:"https://gallery.ecr.aws"},"Amazon ECR Public Gallery"),"."),(0,a.kt)("p",{parentName:"admonition"},"The images are available in the following\n",(0,a.kt)("a",{parentName:"p",href:"https://gallery.ecr.aws"},"Amazon ECR Public Galleries"),":"),(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://gallery.ecr.aws/cypress-io/cypress/base"},"Cypress 'base' Amazon ECR Public Gallery")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://gallery.ecr.aws/cypress-io/cypress/browsers"},"Cypress 'browsers' Amazon ECR Public Gallery")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://gallery.ecr.aws/cypress-io/cypress/included"},"Cypress 'included' Amazon ECR Public Gallery")))),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("strong",null,"Choosing the right Docker Image"),(0,a.kt)("p",{parentName:"admonition"},"For E2E Testing on a CI provider like AWS CodeBuild, the\n",(0,a.kt)("a",{parentName:"p",href:"https://gallery.ecr.aws/cypress-io/cypress/browsers"},"Cypress 'browsers' Amazon ECR Public Gallery"),"\ncontains the images to use."),(0,a.kt)("p",{parentName:"admonition"},"What's the difference in the images?"),(0,a.kt)("p",{parentName:"admonition"},"The ",(0,a.kt)("inlineCode",{parentName:"p"},"base")," Docker images are used by the ",(0,a.kt)("inlineCode",{parentName:"p"},"browsers")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"included")," images for\nthe base operating system and set of initial dependencies, but does not install\nCypress or additional browsers."),(0,a.kt)("p",{parentName:"admonition"},"The ",(0,a.kt)("inlineCode",{parentName:"p"},"browsers")," images extend a ",(0,a.kt)("inlineCode",{parentName:"p"},"base")," image and installs one or more browsers\nsuch as Chrome or Firefox."),(0,a.kt)("p",{parentName:"admonition"},"The ",(0,a.kt)("inlineCode",{parentName:"p"},"included")," images extend a ",(0,a.kt)("inlineCode",{parentName:"p"},"browsers")," image and installs a specific version\nof Cypress and adds a Docker entrypoint for the ",(0,a.kt)("inlineCode",{parentName:"p"},"cypress run")," command. These\nimages are for testing a containerized version of Cypress in a project during\nlocal development and are not used in CI environments.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'## buildspec.yml\nversion: 0.2\n\n## AWS CodeBuild Batch configuration\n## https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html\n## Define build to run using the "cypress/browsers:node18.12.0-chrome106-ff106" image from the Cypress Amazon ECR Public Gallery\nbatch:\n  fast-fail: false\n  build-list:\n    - identifier: cypress-e2e-tests\n      env:\n        image: public.ecr.aws/cypress-io/cypress/browsers:node18.12.0-chrome106-ff106\n\nphases:\n  install:\n    runtime-versions:\n      nodejs: latest\n    commands:\n      # Set COMMIT_INFO variables to send Git specifics to Cypress Cloud when recording\n      # https://docs.cypress.io/guides/continuous-integration/introduction#Git-information\n      - export COMMIT_INFO_BRANCH="$(git rev-parse HEAD | xargs git name-rev |\n        cut -d\' \' -f2 | sed \'s/remotes\\/origin\\///g\')"\n      - export COMMIT_INFO_MESSAGE="$(git log -1 --pretty=%B)"\n      - export COMMIT_INFO_EMAIL="$(git log -1 --pretty=%ae)"\n      - export COMMIT_INFO_AUTHOR="$(git log -1 --pretty=%an)"\n      - export COMMIT_INFO_SHA="$(git log -1 --pretty=%H)"\n      - export COMMIT_INFO_REMOTE="$(git config --get remote.origin.url)"\n      - npm ci\n  pre_build:\n    commands:\n      - npm run cy:verify\n      - npm run cy:info\n  build:\n    commands:\n      - npm run start:ci &\n      - npx cypress run --record --browser firefox\n')),(0,a.kt)("h2",{id:"Caching-Dependencies-and-Build-Artifacts"},"Caching Dependencies and Build Artifacts"),(0,a.kt)("p",null,"Caching with ",(0,a.kt)("a",{parentName:"p",href:"https://aws.amazon.com/codebuild/"},"AWS CodeBuild")," directly can be\nchallenging."),(0,a.kt)("p",null,"The\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/build-caching.html"},"Build caching in AWS CodeBuild"),"\ndocument offers details on local or Amazon S3 caching."),(0,a.kt)("p",null,'Per the documentation, "Local caching stores a cache locally on a build host\nthat is available to that build host only". This will not be useful during\nparallel test runs.'),(0,a.kt)("p",null,'The "Amazon S3 caching stores the cache in an Amazon S3 bucket that is available\nacross multiple build hosts". While this may sound useful, in practice the\nupload of cached dependencies can take some time. Furthermore, each worker will\nattempt to save it\'s dependency cache to Amazon S3, which increases build time\nsignificantly.'),(0,a.kt)("p",null,"Beyond the scope of this guide, but\n",(0,a.kt)("a",{parentName:"p",href:"https://aws.amazon.com/codepipeline"},"AWS CodePipeline")," may be of use to cache\nthe initial source, dependencies and build output for use in AWS CodeBuild jobs\nusing\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codepipeline/latest/userguide/welcome-introducing-artifacts.html"},"AWS CodePipeline Input and Output Artifacts"),"."),(0,a.kt)("p",null,"Reference the\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/sample-pipeline-multi-input-output.html"},"AWS CodePipeline integration with CodeBuild and multiple input sources and output artifacts sample"),"\nexample for details on how to configure a CodePipeline with an output artifact."),(0,a.kt)("h2",{id:"Parallelization"},"Parallelization"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"/guides/cloud/introduction"},"Cypress Cloud")," offers the ability to\n",(0,a.kt)("a",{parentName:"p",href:"/guides/cloud/smart-orchestration/parallelization"},"parallelize and group test runs"),"\nalong with additional insights and ",(0,a.kt)("a",{parentName:"p",href:"/guides/cloud/analytics"},"analytics")," for\nCypress tests."),(0,a.kt)("p",null,"AWS CodeBuild offers a\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html#build-spec.batch.build-matrix"},"batch build-matrix strategy"),"\nfor declaring different job configurations for a single job definition. The\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html#build-spec.batch.build-matrix"},"batch build-matrix strategy"),"\nprovides an option to specify a container image for the job. Jobs declared\nwithin a build-matrix strategy can run in parallel which enables us run\nmultiples instances of Cypress at same time as we will see later in this\nsection."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("strong",null,"Enabling batch builds in the CodeBuild UI for the project"),(0,a.kt)("br",null),(0,a.kt)("br",null),(0,a.kt)("p",{parentName:"admonition"},"Per the\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html"},"AWS CodeBuild batch build documentation"),",\nAWS CodeBuild creates a separate build for each possible configuration\ncombination for a\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html#build-spec.batch.build-matrix"},"batch build-matrix strategy"),".\nTherefore, AWS CodeBuild projects must be created or updated to run batch\nconfiguration."),(0,a.kt)("p",{parentName:"admonition"},"Follow these steps to enable batch configuration for existing AWS CodeBuild\nprojects:"),(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},"Navigate to the AWS CodeBuild Console"),(0,a.kt)("li",{parentName:"ul"},"Select the project"),(0,a.kt)("li",{parentName:"ul"},'Click "Edit" --\x3e "Batch Configuration"'),(0,a.kt)("li",{parentName:"ul"},'Create "New service Role" and enter the name of the role'),(0,a.kt)("li",{parentName:"ul"},"Leave all other options as optional"),(0,a.kt)("li",{parentName:"ul"},'Click "Update batch configuration"'),(0,a.kt)("li",{parentName:"ul"},"Start the Build"))),(0,a.kt)("p",null,"The Cypress team maintains the official\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/cypress-io/cypress-docker-images"},"Docker Images")," for running\nCypress locally and in CI, which are built with Google Chrome and Firefox. This\nallows us to run the tests in Firefox by passing the ",(0,a.kt)("inlineCode",{parentName:"p"},"--browser firefox"),"\nattribute to ",(0,a.kt)("inlineCode",{parentName:"p"},"cypress run"),"."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"The following configuration using the ",(0,a.kt)("inlineCode",{parentName:"p"},"--parallel")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"--record")," flags to\n",(0,a.kt)("a",{parentName:"p",href:"/guides/guides/command-line#cypress-run"},"cypress run")," requires setting up\nrecording test results to ",(0,a.kt)("a",{parentName:"p",href:"/guides/cloud/introduction"},"Cypress Cloud"),".")),(0,a.kt)("h3",{id:"Parallelizing-the-build"},"Parallelizing the build"),(0,a.kt)("p",null,"To setup multiple containers to run in parallel, the ",(0,a.kt)("inlineCode",{parentName:"p"},"build-matrix"),"\nconfiguration uses a set of variables (",(0,a.kt)("inlineCode",{parentName:"p"},"CY_GROUP_SPEC")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"WORKERS"),") with a\nlist of items specific to each group for the build."),(0,a.kt)("p",null,"The fields are delimited by a pipe (",(0,a.kt)("inlineCode",{parentName:"p"},"|"),") character as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"## Group Name | Browser | Specs | Cypress Configuration options (optional)\n\n'UI-Chrome-Mobile|chrome|cypress/tests/ui/*|viewportWidth=375,viewportHeight=667'\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"build-matrix")," will run all permutations delimited items."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"batch:\n  fast-fail: false\n  build-matrix:\n    # ...\n    dynamic:\n      env:\n        # ...\n        variables:\n          CY_GROUP_SPEC:\n            - 'UI-Chrome|chrome|cypress/tests/ui/*'\n            - 'UI-Chrome-Mobile|chrome|cypress/tests/ui/*|viewportWidth=375,viewportHeight=667'\n            - 'API|chrome|cypress/tests/api/*'\n            - 'UI-Firefox|firefox|cypress/tests/ui/*'\n            - 'UI-Firefox-Mobile|firefox|cypress/tests/ui/*|viewportWidth=375,viewportHeight=667'\n")),(0,a.kt)("p",null,"During the install phase, we utilize shell scripting with the\n",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Cut_(Unix)"},"cut command")," to assign values from\nthe delimited ",(0,a.kt)("inlineCode",{parentName:"p"},"CY_GROUP_SPEC")," passed to the worker into shell variables that\nwill be used in the ",(0,a.kt)("inlineCode",{parentName:"p"},"build")," phase when running ",(0,a.kt)("inlineCode",{parentName:"p"},"cypress run"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"batch:\n  # ...\n\nphases:\n  install:\n    commands:\n      # Set COMMIT_INFO variables to send Git specifics to Cypress Cloud when recording\n      # https://docs.cypress.io/guides/continuous-integration/introduction#Git-information\n      - export COMMIT_INFO_BRANCH=\"$(git rev-parse HEAD | xargs git name-rev |\n        cut -d' ' -f2 | sed 's/remotes\\/origin\\///g')\"\n      - export COMMIT_INFO_MESSAGE=\"$(git log -1 --pretty=%B)\"\n      - export COMMIT_INFO_EMAIL=\"$(git log -1 --pretty=%ae)\"\n      - export COMMIT_INFO_AUTHOR=\"$(git log -1 --pretty=%an)\"\n      - export COMMIT_INFO_SHA=\"$(git log -1 --pretty=%H)\"\n      - export COMMIT_INFO_REMOTE=\"$(git config --get remote.origin.url)\"\n      - CY_GROUP=$(echo $CY_GROUP_SPEC | cut -d'|' -f1)\n      - CY_BROWSER=$(echo $CY_GROUP_SPEC | cut -d'|' -f2)\n      - CY_SPEC=$(echo $CY_GROUP_SPEC | cut -d'|' -f3)\n      - CY_CONFIG=$(echo $CY_GROUP_SPEC | cut -d'|' -f4)\n      - npm ci\n## ...\n")),(0,a.kt)("p",null,"To parallelize the runs, we need to add an additional variable to the\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html#build-spec.batch.build-matrix"},"build-matrix strategy"),",\n",(0,a.kt)("inlineCode",{parentName:"p"},"WORKERS"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"batch:\n  fast-fail: false\n  build-matrix:\n    # ...\n    dynamic:\n      env:\n        # ...\n        variables:\n          CY_GROUP_SPEC:\n            # ...\n          WORKERS:\n            - 1\n            - 2\n            - 3\n            - 4\n            - 5\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("strong",null,"Note"),(0,a.kt)("p",{parentName:"admonition"},"The ",(0,a.kt)("inlineCode",{parentName:"p"},"WORKERS")," array is filled with filler (or ",(0,a.kt)("em",{parentName:"p"},"dummy"),") items to provision the\ndesired number of CI machine instances within the\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build-buildspec.html#build-spec.batch.build-matrix"},"batch build-matrix strategy"),"\nand will provide 5 workers to each group defined in the ",(0,a.kt)("inlineCode",{parentName:"p"},"CY_GROUP_SPEC"),".")),(0,a.kt)("p",null,"Finally, the script variables are passed to the call to ",(0,a.kt)("inlineCode",{parentName:"p"},"cypress run"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'phases:\n  install:\n    # ...\n  build:\n    commands:\n      - npm start:ci &\n      - npx cypress run --record --parallel --browser $CY_BROWSER --ci-build-id\n        $CODEBUILD_INITIATOR --group "$CY_GROUP" --spec "$CY_SPEC" --config\n        "$CY_CONFIG"\n')),(0,a.kt)("h2",{id:"Using-Cypress-Cloud-with-AWS-CodeBuild"},"Using Cypress Cloud with AWS CodeBuild"),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},"Dashboard analytics are dependent on your CI environment reliably providing\ncommit SHA data (typically via an environment variable) which is not always\npresent by default. This is not a problem for most users, but if you are facing\nintegration issues with your CodeBuild setup, please make sure the git\ninformation is being sent properly by following\n",(0,a.kt)("a",{parentName:"p",href:"/guides/continuous-integration/introduction#Git-information"},"these guidelines"),",\nor just see\n",(0,a.kt)("a",{parentName:"p",href:"#Basic-Setup"},"the example ",(0,a.kt)("inlineCode",{parentName:"a"},"codebuild.yml")," file at the top of this page"),". If you\nare still facing issues after this, please\n",(0,a.kt)("a",{parentName:"p",href:"mailto:hello@cypress.io"},"contact us"),".")),(0,a.kt)("p",null,"In the AWS CodeBuild configuration we have defined in the previous section, we\nare leveraging three useful features of\n",(0,a.kt)("a",{parentName:"p",href:"/guides/cloud/introduction"},"Cypress Cloud"),":"),(0,a.kt)(c,{mdxType:"CiProviderCloudSteps"}),(0,a.kt)("h2",{id:"Cypress-Real-World-Example-with-AWS-CodeBuild"},"Cypress Real World Example with AWS CodeBuild"),(0,a.kt)("p",null,"A complete CI workflow against multiple browsers, viewports and operating\nsystems is available in the Cypress Real World App (RWA)."),(0,a.kt)("p",null,"Clone the ",(0,a.kt)(u,{name:"github",inline:"true",contentType:"rwa",mdxType:"Icon"})," and refer to\nthe ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/cypress-io/cypress-realworld-app/blob/develop/buildspec.yml"},"buildspec.yml"),"\nfile."))}h.isMDXComponent=!0}}]);